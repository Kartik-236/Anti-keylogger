<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Anti-Keylogger Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0f1724; color:#dfe7f0; padding:20px; }
    .card { background:#0b1220; border:0; }
    .btn-primary { background:#246; border:0; }
    pre { background:#071021; padding:12px; border-radius:6px; white-space:pre-wrap; color:#00ff9f; }
    table th, table td { vertical-align: middle; }
    #liveArea { background:#071021; color:#00ff9f; height:240px; overflow-y:auto; padding:10px; border-radius:8px; font-family:monospace; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-3">Anti-Keylogger Dashboard</h1>

  <div class="mb-3">
    <form action="{{ url_for('start_capture') }}" method="post" style="display:inline-block;">
      <input type="hidden" name="require_pendrive" value="true">
      <button class="btn btn-primary" id="startBtn" type="submit" {% if capture_running %}disabled{% endif %}>Start Capture</button>
    </form>

    <form action="{{ url_for('stop_capture') }}" method="post" style="display:inline-block;">
      <button class="btn btn-danger" id="stopBtn" type="submit" {% if not capture_running %}disabled{% endif %}>Stop Capture</button>
    </form>

    <form action="{{ url_for('delete_all') }}" method="post" style="display:inline-block;" onsubmit="return confirm('Delete ALL encrypted archives? This cannot be undone.')">
      <button class="btn btn-warning">Delete All Logs</button>
    </form>

    <span class="ms-3">Pendrive: 
      <strong style="color: {{ 'lime' if pendrive_connected else 'red' }}">
        {{ 'Connected' if pendrive_connected else 'Not connected' }}
      </strong>
    </span>
  </div>

  <!-- Row with Live Preview and Activity -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <div class="card p-3">
        <h5>Live Preview</h5>
        <div id="liveArea">[Waiting for keystrokes...]</div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card p-3">
        <h5>Activity (last 7 days)</h5>
        <canvas id="activityChart" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- Archives Table -->
  <h3 class="mt-4">Archives</h3>
  <table class="table table-sm table-dark table-striped align-middle">
    <thead>
      <tr>
        <th>#</th><th>Filename</th><th>Size</th><th>Time</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if archives %}
        {% for a in archives %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ a.name }}</td>
          <td>{{ (a.size // 1024) }} KB</td>
          <td>{{ a.mtime | datetimeformat }}</td>
          <td>
            <a class="btn btn-sm btn-light" href="{{ url_for('decrypt_file', fname=a.name) }}">View</a>
            <a class="btn btn-sm btn-secondary" href="{{ url_for('download', fname=a.name) }}">Download</a>
            <form method="POST" action="{{ url_for('delete_file', filename=a.name) }}" 
                  style="display:inline;" onsubmit="return confirm('Delete {{ a.name }}?');">
              <button type="submit" class="btn btn-sm btn-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" class="text-center">No archives found.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- JS for Chart + Live Stream -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
  // ðŸ”¹ SSE live preview stream
  const liveArea = document.getElementById("liveArea");
  const evtSource = new EventSource("/stream");
  evtSource.onmessage = function(e) {
    const div = document.createElement("div");
    div.textContent = e.data;
    liveArea.appendChild(div);
    liveArea.scrollTop = liveArea.scrollHeight; // auto-scroll to bottom
  };
  evtSource.onerror = function() {
    const div = document.createElement("div");
    div.textContent = "[Connection lost â€” retrying...]";
    div.style.color = "orange";
    liveArea.appendChild(div);
  };

  // ðŸ”¹ Load chart data
  async function loadActivity() {
    try {
      const res = await fetch("/activity");
      const js = await res.json();
      const ctx = document.getElementById("activityChart");
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: js.labels,
          datasets: [{ label: 'Archives', data: js.values, backgroundColor: '#00b4d8' }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    } catch (e) {
      console.error(e);
    }
  }
  loadActivity();
})();
</script>
</body>
</html>
